<div class="booking-detail-page" *ngIf="booking">
    <div class="page-header">
        <div>
            <h1>{{ booking.serviceName }}</h1>
            <span class="booking-number">{{ booking.bookingNumber }}</span>
        </div>
        <span class="status-badge" [ngClass]="'status-' + booking.status.toLowerCase()">
            {{ booking.status }}
        </span>
    </div>

    <div class="detail-grid">
        <!-- Booking Information -->
        <div class="detail-section">
            <h2>Booking Details</h2>
            <div class="info-grid">
                <div class="info-item">
                    <label>Service</label>
                    <span>{{ booking.serviceName }}</span>
                </div>
                <div class="info-item">
                    <label>Scheduled Date</label>
                    <span>{{ booking.scheduledDate | date:'medium' }}</span>
                </div>
                <div class="info-item">
                    <label>Priority</label>
                    <span class="priority" [ngClass]="'priority-' + booking.priority.toLowerCase()">
                        {{ booking.priority }}
                    </span>
                </div>
                <div class="info-item" *ngIf="booking.technicianName">
                    <label>Technician</label>
                    <span>{{ booking.technicianName }}</span>
                </div>
                <div class="info-item">
                    <label>Created</label>
                    <span>{{ booking.createdAt | date:'short' }}</span>
                </div>
            </div>

            <div class="info-item full-width">
                <label>Problem Description</label>
                <p>{{ booking.problemDescription }}</p>
            </div>

            <div class="info-item full-width" *ngIf="booking.specialInstructions">
                <label>Special Instructions</label>
                <p>{{ booking.specialInstructions }}</p>
            </div>
        </div>

        <!-- Address -->
        <div class="detail-section">
            <h2>Service Address</h2>
            <!-- Handle nested serviceAddress object -->
            <ng-container *ngIf="booking.serviceAddress?.addressLine1">
                <p>{{ booking.serviceAddress?.addressLine1 }}</p>
                <p *ngIf="booking.serviceAddress?.addressLine2">{{ booking.serviceAddress?.addressLine2 }}</p>
                <p *ngIf="booking.serviceAddress?.city">{{ booking.serviceAddress?.city }}<span
                        *ngIf="booking.serviceAddress?.state">, {{ booking.serviceAddress?.state }}</span> {{
                    booking.serviceAddress?.zipCode }}</p>
            </ng-container>
            <!-- Fallback to flat address fields -->
            <ng-container *ngIf="!booking.serviceAddress?.addressLine1 && booking.addressLine1">
                <p>{{ booking.addressLine1 }}</p>
                <p *ngIf="booking.addressLine2">{{ booking.addressLine2 }}</p>
                <p *ngIf="booking.city">{{ booking.city }}<span *ngIf="booking.state">, {{ booking.state }}</span> {{
                    booking.zipCode }}</p>
            </ng-container>
            <!-- No address available -->
            <p *ngIf="!booking.serviceAddress?.addressLine1 && !booking.addressLine1" class="no-address">
                Address not available
            </p>
        </div>
    </div>

    <!-- Actions -->
    <div class="actions-section" *ngIf="canPerformActions()">
        <button *ngIf="booking.status === 'PENDING' || booking.status === 'ASSIGNED'" class="btn-cancel"
            (click)="showCancelDialog = true">
            Cancel Booking
        </button>

        <button *ngIf="booking.status === 'COMPLETED' && !booking.rating" class="btn-rate"
            (click)="showRatingDialog = true">
            Rate Service
        </button>

        <button *ngIf="booking.status === 'IN_PROGRESS'" class="btn-otp" (click)="showOtpDialog = true">
            Generate OTP
        </button>

        <a *ngIf="invoice" class="btn-invoice" [routerLink]="['/customer/invoices', invoice.id]">
            View Invoice
        </a>
    </div>

    <!-- Cancel Dialog -->
    <div class="modal" *ngIf="showCancelDialog" (click)="showCancelDialog = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h3>Cancel Booking</h3>
            <form [formGroup]="cancelForm" (ngSubmit)="cancelBooking()">
                <div class="form-group">
                    <label>Reason for cancellation *</label>
                    <textarea formControlName="reason" rows="4" class="form-control"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="showCancelDialog = false">Close</button>
                    <button type="submit" class="btn-danger" [disabled]="!cancelForm.valid">Confirm Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rating Dialog -->
    <div class="modal" *ngIf="showRatingDialog" (click)="showRatingDialog = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h3>Rate Service</h3>
            <form [formGroup]="ratingForm" (ngSubmit)="rateBooking()">
                <div class="form-group">
                    <label>Rating *</label>
                    <div class="star-rating">
                        <span *ngFor="let star of [1,2,3,4,5]" class="star"
                            [class.selected]="star <= (ratingForm.get('rating')?.value || 0)"
                            (click)="ratingForm.patchValue({rating: star})">
                            â˜…
                        </span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Feedback</label>
                    <textarea formControlName="feedback" rows="4" class="form-control"
                        placeholder="Share your experience..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="showRatingDialog = false">Close</button>
                    <button type="submit" class="btn-primary" [disabled]="!ratingForm.valid">Submit Rating</button>
                </div>
            </form>
        </div>
    </div>

    <!-- OTP Dialog -->
    <div class="modal" *ngIf="showOtpDialog" (click)="showOtpDialog = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h3>Service Completion OTP</h3>
            <p *ngIf="!booking.otp">Click the button below to generate your OTP:</p>
            <div *ngIf="booking.otp" class="otp-display">
                <p>Your OTP is:</p>
                <h2>{{ booking.otp }}</h2>
                <p class="otp-note">Share this OTP with the technician to confirm service completion</p>
            </div>
            <div class="modal-actions">
                <button *ngIf="!booking.otp" type="button" class="btn-primary" (click)="generateOtp()">Generate
                    OTP</button>
                <button type="button" class="btn-secondary" (click)="showOtpDialog = false">Close</button>
            </div>
        </div>
    </div>
</div>